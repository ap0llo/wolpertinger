Authentication===============Clusters---------For security reasons, instances of Wolpertinger, per default, won't talk to arbitrary other instances but only to instances that are part of the same "Cluster" (well, expect for authenticating a client's Cluster membership). Clusters are groups of clients that share the same cluster-key.The Cluster key has to be manually shared between all participating clients. There is no mechanism of automatically distributing the key (yet).Currently the reference implementation does not support being part of more then one Cluster, but there is nothing that would prevent such a feature.Trust Levels-------------Each Client assigns a so called "Trust Level" to every connected Client. Every RemoteMethodCall requires a certain trust level to be completed successfully and a callee must refuse all calls with an error if a trust level violation occurred.Authentication Process--------------------------The authentication process consists of four different steps. After each step, the authenticated client reaches a higher trust level and is thus permitted to proceed with the next step.If an authentcation error occurs before the authentication is completed, the connection will be reset and authentication has to be restarted beginning with step 1*In the following article the scenario is that a caller (='Client 1') connects to callee (='Client 2') and performs authentication*### Step 1 - Establishing the Connection**Required Trust Level: 0, Trust Level after completion: 1**The first step of authentication actually isn't authentication at all, but instead just establishes the connection and exchanges basic information.To establish the connection, the caller has to call the callee's "EstablishConnection" RemoteMethod. The callee will answer with a boolean value indicating wheter it is ready and willing to accept the connection. If successful, the clients should assign each other trust level 1.### Step 2 - Key-Exchange**Required Trust Level: 1, Trust Level after completion: 2**To secure communication, all communication above trust level 2 is encrypted using AES. Therefore the clients need to exchange a key using the Diffie-Hellman-Key-Exchange. To do that, the caller needs to call the callee's KeyExchange method and pass in the public part of its Diffie-Hellman-Key and a  Initialization-Vector (IV) for the AES encryption as parameters. The callee can use this and its own public key to generate a connection key and will respond to the call with its public key so that the caller can calculate the connection key, too.Sending the IV in clear-text before the connection is encrypted does not pose a security problem.The algorithm used to derive key material for the exchange is *SHA256*. The default implementation uses the .NET-built-in Diffie-Hellman-implementation, described [here](http://blogs.msdn.com/b/shawnfa/archive/2007/01/22/elliptic-curve-diffie-hellman.aspx).##Step 3 - Cluster Authentication**Required Trust Level: 2, Trust Level after completion: 3**Now that we have a secure way of exchanging messages, the clients need to verify that the respectively other client is part of the same cluster. To do that, the caller first needs get a authentication token by calling 'ClusterAuthGetToken'. The callee will respond with a token that can be used just once. This token is then used as a salt to calculate a hash of the cluster-key.The hash is a 64 byte value calculated using [PDKDF2](http://en.wikipedia.org/wiki/PBKDF2) ([RFC2898](http://tools.ietf.org/html/rfc2898)) with a iteration count of 1000.Once the caller has calculated the hash, it has to pass the hash (base64-encoded) as a parameter to ClusterAuthVerify. The callee will answer with a boolean value indicating whether the hash was correct or not. If it was correct, the calller is assigned trust level 3.Now, the caller needs to verify the callee's cluster membership. In order to do that, the caller generates a new authentication token and passes it to ClusterAuthInitiate. This will make the callee create a hash of the cluster-key using the specified token and call the caller's ClusterAuthVerify method.If everything was successful, both clients should have reached trust level 3 now.##Step 4 - User Authentication**Required Trust Level: 3, Trust Level after completion: 4**Trust Level 3 should be enough for most of the communication between wolpertigner instances. However, for administrative tasks, a client can reach the highest trust level 4. For that, it needs to authenticate itself as a user using a user-name and a password.In contrast to cluster authentication, user authentication is not symmetric. the caller can reach trust level 4 without the callee requiring the same level on the caller's side.The authentication process is similar to cluster authentication. First the caller gets a authentication token by calling UserAuthGetToken and generate a hash of the user's password using the token as a salt. Using UserAuthVerify the caller can authenticate itself by passing user-name and the hashed password as paramters. The callee will, once again, answer with a boolean value indicating whether the login attempt was successfull.Just like in step 3, PBKDF2 with 1000 iterations is used to calculate a 64 byte hash value.See also----------	[Communication Protocol](communication-protocol)-	[Authentication API](authentication-api)